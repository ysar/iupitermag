use numpy::ndarray::{s, ArcArray2, Array1, Array2};
use numpy::{IntoPyArray, PyArray1, PyArray2, PyArrayMethods, PyReadonlyArray2};
use pyo3::{pyclass, pymethods, Bound, Python};

use crate::field::Field;
use crate::impl_field_methods;
use crate::legendre;

// #[derive(Clone)]
#[pyclass]
pub struct PyInternalField {
    pub field: InternalField,
}

#[pymethods]
impl PyInternalField {
    #[new]
    pub fn __init__(
        field_type: &str,
        g_in: Option<PyReadonlyArray2<f64>>,
        h_in: Option<PyReadonlyArray2<f64>>,
        degree_in: Option<usize>,
    ) -> Self {
        let g: Option<Array2<f64>> = g_in.map(|x| x.to_owned_array());
        let h: Option<Array2<f64>> = h_in.map(|x| x.to_owned_array());

        PyInternalField {
            field: InternalField::new(field_type, g, h, degree_in),
        }
    }
    pub fn get_coefficients<'py>(
        &self,
        py: Python<'py>,
    ) -> (Bound<'py, PyArray2<f64>>, Bound<'py, PyArray2<f64>>) {
        let s = legendre::schmidt_semi_normalization_constants(&self.field.degree);

        let g = self.field.g.to_owned() / &s;
        let h = self.field.h.to_owned() / &s;

        (g.into_pyarray(py), h.into_pyarray(py))
    }
}

impl_field_methods!(PyInternalField);

#[derive(Clone)]
pub struct InternalField {
    // Note: Using ArcArray to derive Sync
    g: ArcArray2<f64>,
    h: ArcArray2<f64>,
    degree: usize,
}

impl InternalField {
    pub fn new(
        field_type: &str,
        g_in: Option<Array2<f64>>,
        h_in: Option<Array2<f64>>,
        degree_in: Option<usize>,
    ) -> Self {
        let mut field = match field_type {
            "JRM09" => create_jrm09_field(),
            "JRM33" => create_jrm33_field(),
            "Custom" => {
                let expectmessage = "g and h are expected for Custom field type.";
                InternalField {
                    g: g_in.expect(expectmessage).to_shared(),
                    h: h_in.expect(expectmessage).to_shared(),
                    degree: 0,
                }
            }
            _ => panic!("Unknown field_type: Supported (JRM09, JRM33, Custom)"),
        };

        if let Some(x) = degree_in {
            if x < field.g.nrows() - 1 {
                // Workaround to mutate ArcArray via copy.
                // We are only doing this when initializing, so this should
                // not impact performance as much.

                field.g = field
                    .g
                    .into_owned()
                    .slice_move(s![..x + 1, ..x + 1])
                    .to_shared();

                field.h = field
                    .h
                    .into_owned()
                    .slice_move(s![..x + 1, ..x + 1])
                    .to_shared();
            }
        }

        field.degree = field.g.nrows() - 1;
        field = field.normalize_coefficients();
        field
    }

    fn normalize_coefficients(mut self) -> Self {
        // Normalize the coefficients here rather than in the calculation
        // Since g and h are ArcArray, they are immutable, hence
        // the into_owned and to_shared workaround. This is ugly but it is
        // only done once when the field is initialized.

        let s = legendre::schmidt_semi_normalization_constants(&self.degree);
        self.g = (self.g.into_owned() * &s).to_shared();
        self.h = (self.h.into_owned() * &s).to_shared();
        self
    }
}

impl Field for InternalField {
    fn calc_field(&self, r: f64, theta: f64, phi: f64) -> Array1<f64> {
        let mut b_r: f64 = 0.;
        let mut b_theta: f64 = 0.;
        let mut b_phi: f64 = 0.;

        let a: f64 = 1. / r;

        let g = &self.g;
        let h = &self.h;
        let degree = &self.degree;

        assert!((g.nrows() == g.ncols()) && (h.nrows() == h.ncols()));

        let (p, dp) = legendre::assoc_legendre_poly(&theta, degree);

        let sintheta: f64 = theta.sin();
        let sinphi: f64 = phi.sin();
        let cosphi: f64 = phi.cos();

        let inv_sintheta: f64 = 1. / sintheta; // nan if zero, thats fine.

        let mut sinphi_prev: f64;
        let mut cosphi_prev: f64;
        let mut sin_mphi: f64;
        let mut cos_mphi: f64;

        for i in 0..degree + 1 {
            sinphi_prev = 0.;
            cosphi_prev = 1.;

            let i_i32 = i32::try_from(i).unwrap();

            b_r += a.powi(i_i32 + 2) * (i + 1) as f64 * p[[i, 0]] * g[[i, 0]];
            b_theta -= a.powi(i_i32 + 2) * dp[[i, 0]] * g[[i, 0]];

            for j in 1..i + 1 {
                sin_mphi = sinphi_prev * cosphi + cosphi_prev * sinphi;
                cos_mphi = cosphi_prev * cosphi - sinphi_prev * sinphi;

                b_r += a.powi(i_i32 + 2)
                    * (i + 1) as f64
                    * p[[i, j]]
                    * (g[[i, j]] * cos_mphi + h[[i, j]] * sin_mphi);

                b_theta -=
                    a.powi(i_i32 + 2) * dp[[i, j]] * (g[[i, j]] * cos_mphi + h[[i, j]] * sin_mphi);

                b_phi += inv_sintheta
                    * a.powi(i_i32 + 2)
                    * p[[i, j]]
                    * j as f64
                    * (g[[i, j]] * sin_mphi - h[[i, j]] * cos_mphi);

                sinphi_prev = sin_mphi;
                cosphi_prev = cos_mphi;
            }
        }

        // Should set Bphi to zero if NaN.
        if b_phi.is_nan() {
            b_phi = 0.;
        }

        // return array of bx, by, bz
        Array1::from_vec(vec![b_r, b_theta, b_phi])
    }
}

// Separating the JRM09 constants into a separate function
#[rustfmt::skip]
fn create_jrm09_field() -> InternalField {

    InternalField {

        degree: 10,

        g: ArcArray2::<f64>::from_shape_vec((11, 11), vec![
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            410244.7, -71498.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            11670.4, -56835.8, 48689.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            4018.6, -37791.1, 15926.3, -2710.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -34645.4, -8247.6, -2406.1, -11083.8, -17837.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -18023.6, 4683.9, 16160.0, -16402.0, -2600.7, -3660.7, 0.0, 0.0, 0.0, 0.0, 0.0,
            -20819.6, 9992.9, 11791.8, -12574.7, 2669.7, 1113.2, 7584.9, 0.0, 0.0, 0.0, 0.0,
            598.4, 4665.9, -6495.7, -2516.5, -6448.5, 1855.3, -2892.9, 2968.0, 0.0, 0.0, 0.0,
            10059.2, 1934.4, -6702.9, 153.7, -4124.2, -867.2, -3740.6, -732.4, -2433.2, 0.0, 0.0,
            9671.8, -3046.2, 260.9, 2071.3, 3329.6, -2523.1, 1787.1, -1148.2, 1276.5, -1976.8, 0.0,
            -2299.5, 2009.7, 2127.8, 3498.3, 2967.6, 16.3, 1806.5, -46.5, 2897.8, 574.5, 1298.9,
            ]).unwrap(),

        h: ArcArray2::<f64>::from_shape_vec((11, 11), vec![
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 21330.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -42027.3, 19353.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -32957.3, 42084.5, -27544.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 31994.5, 27811.2, -926.1, 367.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 45347.9, -749.0, 6268.5, 10859.6, 9608.4, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 14533.1, -10592.9, 568.6, 12871.7, -4147.8, 3604.4, 0.0, 0.0, 0.0, 0.0,
            0.0, -7626.3, -10948.4, 2633.3, 5394.2, -6050.8, -1526.0, -5684.2, 0.0, 0.0, 0.0,
            0.0, -2409.7, -11614.6, 9287.0, -911.9, 2754.5, -2446.1, 1207.3, -2887.3, 0.0, 0.0,
            0.0, -8467.4, -1383.8, 5697.7, -2056.3, 3081.5, -721.2, 1352.5, -210.1, 1567.6, 0.0,
            0.0, -4692.6, 4445.8, -2378.6, -2204.3, 164.1, -1361.6, -2031.5, 1411.8, -714.3, 1676.5,
            ]).unwrap(),
    }
}

#[rustfmt::skip]
fn create_jrm33_field() -> InternalField {

    InternalField {

        degree: 30,

        g: ArcArray2::<f64>::from_shape_vec((31, 31), vec![
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            410993.4, -71305.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            11796.7, -56972.4, 48250.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            2799.3, -37488.4, 15396.8, -1489.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -34402.0, -8080.8, -2440.5, -10848.3, -17919.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -18265.7, 4221.8, 16599.5, -17345.8, -2544.5, -4987.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -20968.0, 9887.6, 12192.4, -12548.7, 2742.2, 1557.6, 8018.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            59.9, 5366.1, -7099.5, -1533.4, -7055.7, 3060.6, -2488.3, 3700.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            10849.5, 1323.8, -6952.2, -95.0, -4746.6, -1301.7, -4284.6, -1436.7, -3024.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            8914.4, -3506.7, 288.1, 773.6, 3592.7, -3170.8, 1406.3, -1526.6, 1313.3, -2314.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -2516.5, 1883.2, 2836.1, 4259.4, 3776.7, 764.4, 2112.3, 724.8, 2496.3, 840.1, 1179.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            1311.6, 3056.9, -2060.6, 3550.1, 589.7, 194.8, -1073.3, -521.7, 685.3, 350.2, -326.6, 1088.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            2300.5, 1688.4, -291.7, 483.2, -581.9, -818.4, -1095.6, -1987.8, 484.5, -1473.1, -666.5, -755.4, -220.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            751.5, -456.4, 1160.4, -2307.8, -77.1, -16.9, 594.8, -950.7, 1042.3, -641.8, 41.6, -229.1, -40.3, -287.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            1164.6, -2478.0, 907.7, -1280.7, 148.5, 1468.8, -8.1, 604.5, 787.2, 327.7, 111.6, 245.2, 127.3, 425.9, 6.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            469.4, -1929.2, -38.7, -815.9, -775.7, 31.0, -149.9, 318.2, -298.3, -149.3, 241.4, -69.4, 367.0, -22.2, 91.8, -43.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -809.2, -888.9, -604.0, -339.1, -350.6, -503.8, -235.5, 9.0, -498.7, -283.2, -50.9, -515.2, -255.3, 15.6, -24.7, -176.5, 49.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -1238.7, -190.2, -101.5, -58.0, 10.0, -525.9, 468.4, 88.1, -385.1, 77.6, 75.7, -148.9, 201.8, 61.7, -243.6, 168.2, -42.2, 7.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -796.0, 443.6, 266.9, 391.2, 366.2, 175.8, 512.5, 151.0, 214.9, 243.4, 337.5, -10.2, -34.9, 161.2, 222.3, -119.6, 28.0, 132.6, -180.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -493.7, 486.7, -62.0, 539.2, 187.4, 136.8, -9.4, -581.2, 291.8, -198.1, 95.5, -372.6, 190.7, -119.6, -11.9, 74.4, -391.4, -33.1, -118.0, -57.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -319.9, 113.6, -262.2, 94.2, -306.7, -139.2, -291.5, -716.6, 55.5, -219.0, -165.1, -206.6, -115.7, -117.5, -56.9, -6.9, 31.4, -146.9, 453.7, -256.5, 424.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -71.5, -157.0, -127.9, -73.9, -98.0, 222.1, -299.3, -124.8, 155.6, 61.0, -137.5, -52.1, -177.1, -51.6, 44.3, 35.7, -365.8, 91.4, -200.6, 28.0, -113.8, 16.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -48.6, -197.9, -16.4, 84.0, 155.6, 194.9, -91.6, 55.5, 183.6, 43.1, -16.4, -149.6, 33.1, -39.4, 123.4, -62.2, -74.9, -28.0, 142.1, 147.2, -307.5, 228.2, -365.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            -53.7, -120.7, 23.0, 53.9, -25.8, -185.5, 65.2, -45.7, -22.3, -34.5, 10.4, -158.9, -15.6, -59.4, 122.2, -119.5, -18.3, 108.2, -35.6, -94.6, 147.0, -88.5, 199.1, -121.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            128.5, -31.9, 38.5, -80.7, -118.6, -177.4, 44.8, -26.8, -153.3, 7.6, -49.6, -48.7, -122.1, -1.7, 40.1, -57.1, -82.7, 170.5, -109.1, 28.0, -45.5, -42.1, 16.4, -42.7, 174.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            203.0, 42.3, 17.1, -79.5, -1.5, 31.4, 18.8, 21.5, -94.6, 35.0, -60.6, -11.7, -84.7, 60.1, 5.8, -4.9, 25.9, 117.3, 9.2, 99.6, -126.2, 34.2, 25.9, 23.7, 89.8, 63.2, 0.0, 0.0, 0.0, 0.0, 0.0,
            42.0, 69.7, -12.6, -7.0, 58.4, 71.8, 30.1, 24.8, 0.7, 8.7, 10.8, -21.4, -0.1, 27.6, 17.1, 23.1, 59.9, 89.4, 40.0, -30.5, -42.5, 29.0, -21.3, 5.1, -205.5, 60.1, -142.3, 0.0, 0.0, 0.0, 0.0,
            -97.3, 29.4, -17.8, 30.4, 23.1, 16.1, 13.1, 8.6, 28.3, -14.0, 52.4, 10.3, 17.4, -33.2, 12.0, 22.1, 15.7, 42.5, 18.8, -62.5, -23.7, 15.4, -38.5, -10.2, -106.4, -25.5, -2.6, -86.8, 0.0, 0.0, 0.0,
            -66.8, -19.6, -3.9, 27.8, -9.3, -6.2, -12.2, -6.2, 16.7, -9.1, 17.8, 34.2, -0.4, -30.6, -3.2, 2.9, 1.7, -19.7, 2.2, 16.7, -20.5, -3.5, 9.8, 7.6, 12.8, -35.4, 43.7, 10.5, -23.6, 0.0, 0.0,
            15.3, -22.2, 8.2, 5.4, -10.1, -4.4, -13.1, -6.5, 3.0, 4.2, -19.7, 13.2, 1.2, 6.9, -7.7, -1.8, 6.1, -27.1, -11.2, 40.6, 8.1, -14.3, 23.9, 11.5, 2.0, -9.8, 5.2, 4.1, 42.8, 5.3, 0.0,
            32.2, -0.1, 8.0, -12.8, -0.8, -4.6, -3.2, 0.8, -5.9, 4.4, -14.3, -9.4, 8.0, 16.1, -3.3, 3.6, 3.7, 1.0, -10.9, 4.3, 21.2, -5.4, 0.7, -5.2, -13.0, 5.0, -19.2, -14.3, 32.1, 28.0, 26.9,
            ]).unwrap(),

        h: ArcArray2::<f64>::from_shape_vec((31, 31), vec![
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 20958.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -42549.0, 20221.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -32890.6, 42518.4, -27397.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 32452.4, 27438.6, -501.4, -1325.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 45363.1, -826.2, 6000.6, 10568.8, 10091.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 14016.9, -10119.1, -294.9, 13948.3, -3686.9, 4783.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -7654.8, -11398.6, 2171.0, 5301.6, -6618.1, -1933.8, -5802.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -2297.4, -12833.5, 10019.6, -1725.6, 2387.1, -3237.1, 906.1, -3178.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -7899.6, -1328.3, 6566.5, -1275.3, 3617.1, -194.8, 1960.3, 956.9, 1831.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -5689.8, 5570.3, -2541.6, -1795.2, -217.8, -628.3, -1619.6, 454.6, -840.0, 1581.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 549.1, 4527.6, -4223.0, -2761.9, -476.0, -2714.4, -1349.2, -1649.0, -1471.5, -583.0, -499.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 4204.2, 2228.0, -1901.1, -1271.2, 1073.4, -1111.9, 872.9, -837.9, -462.8, -22.0, 110.3, -712.7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 4125.6, -44.0, -455.4, 2160.6, 255.4, 1105.1, 1214.2, 196.1, -207.7, 1195.7, 472.4, 721.6, 51.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -847.8, -124.9, 108.8, 1456.2, -1284.6, 896.5, 237.0, 225.8, -80.9, 696.9, 326.5, 225.9, 71.0, 124.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -1146.4, -580.4, 527.3, 120.0, -478.9, 148.4, 45.7, -882.5, -206.6, -74.9, 51.0, 36.4, -44.4, -285.9, 135.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -932.8, -608.1, 510.2, -587.4, -39.4, 358.1, 279.8, 244.5, 487.3, 366.7, 93.9, 282.8, -267.7, 39.8, -213.1, 32.4, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -209.2, -15.8, 54.4, 308.7, 722.0, 233.3, -82.1, 221.5, 488.6, 206.3, 176.7, 353.4, 204.8, -29.5, 12.8, -89.6, -166.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 670.9, -176.1, -340.3, 37.0, 304.3, -348.8, -291.9, 165.6, 360.9, -119.0, 100.1, 26.9, 1.0, -60.2, 66.5, 277.8, 29.1, 15.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 85.8, -412.1, -502.0, -425.1, -232.2, -477.0, -463.5, 73.6, -228.3, -96.8, -256.0, -228.0, 119.3, -76.9, -319.8, -284.0, 197.9, -239.6, 302.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -297.6, -13.7, -118.4, 105.6, 101.9, 45.3, -213.0, 372.5, -382.8, 154.2, -290.3, 17.1, 6.7, 13.2, -49.3, -32.2, -152.8, 62.2, 8.5, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -155.8, 312.3, 291.1, 207.9, 165.8, 291.2, 198.8, 442.1, -104.0, 209.6, -45.0, -139.6, 229.4, -59.8, -30.0, -182.0, 162.1, 131.7, -356.9, 379.5, -318.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -52.5, 180.6, 182.5, -69.5, -24.5, 93.2, 188.1, 54.5, -68.5, 93.8, -87.3, -175.3, 202.4, -49.8, -129.2, -241.1, -63.6, 68.4, 168.1, -160.0, 62.6, -117.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 52.8, -2.1, -51.9, -92.9, -7.9, 21.1, 16.4, -51.3, -135.8, 56.1, -172.6, 40.8, 21.3, 19.6, -63.1, -135.9, -3.1, 55.9, -63.5, -6.3, 188.1, -119.3, 313.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 59.4, -45.4, -76.0, 13.9, 26.5, 63.0, 9.1, 29.6, -7.6, 38.3, -81.6, 63.3, 40.0, 50.3, -52.5, -88.2, 99.9, 59.3, -52.2, 106.4, -62.1, 34.6, -171.1, 43.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, -6.2, -62.4, -17.5, 72.8, -6.1, -12.2, 28.2, -18.0, 122.4, -33.4, 24.0, 19.7, 70.6, 62.2, -60.1, -54.4, 54.0, -48.5, 45.4, 24.9, -77.3, 36.9, 4.8, 85.7, -262.0, 0.0, 0.0, 0.0, 0.0, 0.0,
            0.0, 5.1, -50.8, 9.5, 33.9, -7.2, -73.0, -12.9, -48.1, 55.4, -60.8, 39.0, 46.9, 43.8, 29.2, -1.9, 5.8, 36.0, -113.8, 29.2, -22.9, -10.0, -23.4, -30.5, 66.7, 126.9, -43.3, 0.0, 0.0, 0.0, 0.0,
            0.0, 23.2, 8.1, 16.8, -44.1, 6.2, -17.0, -30.2, 0.7, -45.5, -18.1, 13.2, 31.8, 20.7, -14.4, 30.7, 41.0, 23.0, -56.4, 1.6, -14.7, -16.3, -31.1, -32.5, -49.2, 79.7, -45.3, 35.8, 0.0, 0.0, 0.0,
            0.0, -9.5, 37.4, 14.0, -46.1, -2.3, 34.7, -6.7, 21.6, -33.1, 16.6, -0.5, -20.5, -3.9, -16.5, 14.5, 20.4, -14.2, 15.7, -12.9, -11.8, -42.8, -8.6, 27.4, -67.5, -2.2, -19.2, 28.9, 79.4, 0.0, 0.0,
            0.0, -23.6, 13.4, 0.8, 9.2, -9.7, 17.2, 11.0, 4.0, 14.7, 13.9, -2.4, -28.1, -21.7, 1.6, 1.5, -9.8, -21.9, 26.9, -15.6, -12.6, -28.6, 8.0, 25.6, -11.0, -10.3, -17.9, 2.0, 5.8, 40.6, 0.0,
            0.0, -1.0, -10.2, -8.8, 29.1, -2.4, -10.4, 6.7, -4.9, 16.9, 2.3, -1.6, -3.2, -14.0, 8.2, 0.5, -9.8, -4.4, 6.2, -5.8, -4.7, 0.1, 10.2, -3.4, 9.9, -2.5, -11.7, -10.5, -21.5, 14.6, 38.3,
            ]).unwrap(),
    }
}

#[cfg(test)]
mod tests {
    #[test]
    fn test_calc_field() {
        use crate::field::Field;
        use crate::internal;
        use ndarray::Array;
        use std::f64::consts::PI;

        let internal_field = internal::InternalField::new("JRM09", None, None, None);

        let val = internal_field.calc_field(10., 0.5 * PI, 0.);

        let val_test = Array::from_vec(vec![
            -131.37542382178387,
            400.6375083598106,
            -24.205489499871465,
        ]);

        for i in 0..3 {
            assert!(
                (val[i] - val_test[i]) < 1e-4,
                "Internal Field Test Fail: \n Calculated {:?}, Expected {:?}",
                val,
                val_test
            );
        }
    }
}
